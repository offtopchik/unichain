#!/bin/bash

set -e

NODE_DIR="unichain-node"

function install_node() {
    echo "=== Установка Unichain Node ==="
    
    # Обновление системы
    echo "Обновляем систему..."
    sudo apt update && sudo apt upgrade -y

    # Установка необходимых инструментов
    echo "Устанавливаем базовые пакеты..."
    sudo apt install -y curl git build-essential unzip wget software-properties-common

    # Установка Node.js
    echo "Устанавливаем Node.js..."
    curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
    sudo apt install -y nodejs

    # Проверка установки Node.js
    echo "Проверяем установку Node.js..."
    node -v
    npm -v

    # Установка Go
    echo "Устанавливаем Go..."
    GO_VERSION="1.21.1"
    wget https://go.dev/dl/go${GO_VERSION}.linux-amd64.tar.gz
    sudo tar -C /usr/local -xzf go${GO_VERSION}.linux-amd64.tar.gz
    rm go${GO_VERSION}.linux-amd64.tar.gz
    echo "export PATH=\$PATH:/usr/local/go/bin" >> ~/.bashrc
    source ~/.bashrc
    go version

    # Клонирование репозитория Unichain Node
    echo "Клонируем репозиторий Unichain Node..."
    if [ ! -d "$NODE_DIR" ]; then
        git clone https://github.com/Uniswap/unichain-node.git
    else
        echo "Репозиторий уже склонирован."
    fi
    cd $NODE_DIR

    # Установка зависимостей проекта
    echo "Устанавливаем зависимости проекта..."
    npm install

    # Установка Docker
    echo "Устанавливаем Docker..."
    sudo apt install -y docker.io
    sudo systemctl start docker
    sudo systemctl enable docker
    sudo usermod -aG docker $USER

    # Установка Docker Compose
    echo "Устанавливаем Docker Compose..."
    sudo curl -L "https://github.com/docker/compose/releases/download/2.20.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
    sudo chmod +x /usr/local/bin/docker-compose
    docker-compose --version

    # Сборка и запуск
    echo "Собираем и запускаем Unichain Node..."
    npm run build
    npm run start &
    echo "Unichain Node установлена и запущена."
}

function restart_node() {
    echo "=== Перезапуск Unichain Node ==="
    if [ -d "$NODE_DIR" ]; then
        cd $NODE_DIR
        pkill -f "npm run start" || echo "Нода не запущена. Запускаем заново."
        npm run start &
        echo "Unichain Node перезапущена."
    else
        echo "Unichain Node не установлена. Сначала выполните установку."
    fi
}

function stop_node() {
    echo "=== Остановка Unichain Node ==="
    pkill -f "npm run start" && echo "Unichain Node остановлена." || echo "Unichain Node не запущена."
}

while true; do
    echo ""
    echo "Меню:"
    echo "1) Установить ноду"
    echo "2) Перезапустить ноду"
    echo "3) Остановить ноду"
    echo "4) Выйти"
    read -rp "Выберите пункт: " choice

    case $choice in
        1) install_node ;;
        2) restart_node ;;
        3) stop_node ;;
        4) echo "Выход."; exit 0 ;;
        *) echo "Неверный выбор. Попробуйте снова." ;;
    esac
done
